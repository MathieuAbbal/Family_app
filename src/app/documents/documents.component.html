<div class="max-w-2xl mx-auto px-4">
  <div class="text-center mb-6">
    <h1 class="font-display text-2xl font-bold text-gradient">üóÇÔ∏è Documents famille</h1>
  </div>

  @if (!isConnected) {
    <div class="card-fun p-8 text-center">
      <div class="text-4xl mb-4">üìÅ</div>
      <h2 class="font-display font-bold text-gray-700 mb-2">Google Drive</h2>
      <p class="text-sm text-gray-500 mb-4">Connecte ton compte Google pour partager des documents avec la famille</p>
      <button (click)="connectGoogle()" class="btn-gradient px-6">Connecter Google Drive</button>
    </div>
  }

  @if (isConnected) {
    <!-- Breadcrumb -->
    <div class="flex items-center gap-1 text-sm mb-4 flex-wrap">
      <button (click)="goToRoot()" class="px-2 py-1 rounded hover:bg-gray-100 transition-colors font-medium"
        [class.text-family-purple]="breadcrumb.length === 0"
        [class.text-gray-500]="breadcrumb.length > 0">
        üè† FamilyApp
      </button>
      @for (item of breadcrumb; track item.id; let i = $index) {
        <span class="text-gray-300">/</span>
        <button (click)="goToBreadcrumb(i)" class="px-2 py-1 rounded hover:bg-gray-100 transition-colors"
          [class.text-family-purple]="i === breadcrumb.length - 1"
          [class.text-gray-500]="i !== breadcrumb.length - 1">
          üìÅ {{item.name}}
        </button>
      }
    </div>

    <!-- Actions bar -->
    <div class="flex gap-2 mb-4">
      @if (breadcrumb.length > 0) {
        <button (click)="goUp()" class="card-fun px-3 py-2 text-sm flex items-center gap-1.5 text-gray-500 hover:text-family-purple transition-colors">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
          Retour
        </button>
      }
      <button (click)="openNewFolderModal()" class="card-fun px-3 py-2 text-sm flex items-center gap-1.5 text-gray-500 hover:text-family-purple transition-colors">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
        Nouveau dossier
      </button>
      <label class="card-fun px-3 py-2 text-sm flex items-center gap-1.5 text-gray-500 hover:text-family-purple transition-colors cursor-pointer">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
        Ajouter fichier
        <input type="file" (change)="onFileSelected($event)" class="hidden" />
      </label>
    </div>

    @if (uploading) {
      <div class="card-fun p-3 mb-4 flex items-center gap-2 text-sm text-gray-500">
        <div class="w-4 h-4 border-2 border-family-purple border-t-transparent rounded-full animate-spin"></div>
        Upload en cours...
      </div>
    }

    @if (loading) {
      <div class="text-center py-8 text-gray-400">
        <div class="w-6 h-6 border-2 border-family-purple border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
        Chargement...
      </div>
    }

    @if (!loading) {
      <!-- Folders -->
      @if (folders.length > 0) {
        <div class="mb-4">
          <h3 class="font-display font-bold text-xs text-gray-400 uppercase tracking-wider mb-2">Dossiers</h3>
          <div class="grid grid-cols-2 gap-2">
            @for (folder of folders; track folder.id) {
              <div class="card-fun p-3 cursor-pointer hover:shadow-card-hover transition-all group relative"
                   [class.ring-2]="dragOverFolder === folder.id"
                   [class.ring-family-purple]="dragOverFolder === folder.id"
                   [class.bg-family-purple/5]="dragOverFolder === folder.id"
                   (dragover)="onDragOver($event, folder)"
                   (dragleave)="onDragLeave(folder)"
                   (drop)="onDrop($event, folder)">
                <div (click)="openFolder(folder)" class="flex items-center gap-2">
                  <span class="text-2xl">üìÅ</span>
                  <span class="font-medium text-gray-700 truncate flex-1">{{folder.name}}</span>
                </div>
                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                  <button (click)="openRenameModal(folder); $event.stopPropagation()" class="p-1 text-gray-400 hover:text-family-purple">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                  </button>
                  <button (click)="openDeleteModal(folder); $event.stopPropagation()" class="p-1 text-gray-400 hover:text-red-400">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Files -->
      @if (documents.length > 0) {
        <div class="mb-4">
          <h3 class="font-display font-bold text-xs text-gray-400 uppercase tracking-wider mb-2">Fichiers</h3>
          <div class="card-fun overflow-hidden divide-y divide-gray-100">
            @for (file of documents; track file.id) {
              <div class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition-colors group cursor-grab active:cursor-grabbing"
                   draggable="true"
                   (dragstart)="onDragStart($event, file)"
                   (dragend)="onDragEnd()"
                   [class.opacity-50]="draggedFile?.id === file.id">
                <span class="text-xl flex-shrink-0">{{getFileIcon(file.mimeType)}}</span>
                <div class="flex-1 min-w-0 cursor-pointer" (click)="openFile(file)">
                  <p class="font-medium text-gray-700 truncate hover:text-family-purple transition-colors">{{file.name}}</p>
                  <p class="text-xs text-gray-400 truncate">
                    @if (file.uploadedByName) {
                      <span>{{file.uploadedByName}} ¬∑ </span>
                    }
                    {{file.createdTime | date: "d MMM yyyy" : '' : 'fr'}}
                  </p>
                </div>
                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                  <button (click)="openRenameModal(file)" class="p-1 text-gray-400 hover:text-family-purple">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                  </button>
                  <button (click)="openDeleteModal(file)" class="p-1 text-gray-400 hover:text-red-400">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      @if (folders.length === 0 && documents.length === 0) {
        <div class="text-center py-12 text-gray-400">
          <div class="text-4xl mb-3">üì≠</div>
          <p class="font-medium">Dossier vide</p>
          <p class="text-sm mb-4">Ajoute un fichier ou cr√©e un dossier !</p>
          <button (click)="reconnectGoogle()" class="text-sm text-family-purple hover:underline">
            Probl√®me d'acc√®s ? Reconnecter Google Drive
          </button>
        </div>
      }
    }
  }
</div>

<!-- New Folder Modal -->
@if (showNewFolderModal) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="closeNewFolderModal()">
    <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Nouveau dossier</h3>
      <input [(ngModel)]="newFolderName" (keydown.enter)="createFolder()"
        placeholder="Nom du dossier"
        class="input-fun w-full mb-4" autofocus />
      <div class="flex gap-3">
        <button (click)="closeNewFolderModal()"
          class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition-colors">
          Annuler
        </button>
        <button (click)="createFolder()" [disabled]="!newFolderName.trim()"
          class="flex-1 px-4 py-2.5 rounded-xl bg-family-purple text-white font-medium hover:bg-family-purple/90 disabled:opacity-40 transition-colors">
          Cr√©er
        </button>
      </div>
    </div>
  </div>
}

<!-- Rename Modal -->
@if (showRenameModal) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="closeRenameModal()">
    <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Renommer</h3>
      <input [(ngModel)]="renameName" (keydown.enter)="confirmRename()"
        placeholder="Nouveau nom"
        class="input-fun w-full mb-4" autofocus />
      <div class="flex gap-3">
        <button (click)="closeRenameModal()"
          class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition-colors">
          Annuler
        </button>
        <button (click)="confirmRename()" [disabled]="!renameName.trim()"
          class="flex-1 px-4 py-2.5 rounded-xl bg-family-purple text-white font-medium hover:bg-family-purple/90 disabled:opacity-40 transition-colors">
          Renommer
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Modal -->
@if (showDeleteModal) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="closeDeleteModal()">
    <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6" (click)="$event.stopPropagation()">
      <div class="text-center">
        <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
          <svg class="w-7 h-7 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Supprimer ?</h3>
        <p class="text-sm text-gray-500 mb-6">
          @if (deleteTarget?.isFolder) {
            Le dossier et tout son contenu seront supprim√©s.
          } @else {
            Ce fichier sera supprim√© d√©finitivement.
          }
        </p>
        <div class="flex gap-3">
          <button (click)="closeDeleteModal()"
            class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition-colors">
            Annuler
          </button>
          <button (click)="confirmDelete()"
            class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600 transition-colors">
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
}
